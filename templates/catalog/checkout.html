{% extends "base.html" %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ‚Äî Hardcode Store{% endblock %}
{% block body_class %}store-page-checkout{% endblock %}

{% block content %}
<h1 class="store-page-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>

<div class="store-checkout">
  <nav class="store-checkout-stepper" aria-label="–≠—Ç–∞–ø—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è">
    <div class="store-checkout-step store-checkout-step-active" data-step="1">
      <span class="store-checkout-step-num">1</span>
      <span class="store-checkout-step-label">–ö–æ—Ä–∑–∏–Ω–∞</span>
    </div>
    <div class="store-checkout-step-line"></div>
    <div class="store-checkout-step" data-step="2">
      <span class="store-checkout-step-num">2</span>
      <span class="store-checkout-step-label">–î–æ—Å—Ç–∞–≤–∫–∞</span>
    </div>
    <div class="store-checkout-step-line"></div>
    <div class="store-checkout-step" data-step="3">
      <span class="store-checkout-step-num">3</span>
      <span class="store-checkout-step-label">–û–ø–ª–∞—Ç–∞</span>
    </div>
  </nav>

  <form action="{% url 'catalog:checkout' %}" method="post" id="checkout-form" class="store-checkout-form">
    {% csrf_token %}
    <p class="store-checkout-hint">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è ‚Äî –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–π–º—ë—Ç –ø–∞—Ä—É –º–∏–Ω—É—Ç.</p>
    <div class="store-checkout-panels">
      <div class="store-checkout-panel store-checkout-panel-visible" data-panel="1">
        <h2 class="store-checkout-panel-title">1. –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h2>
        <div class="store-checkout-items">
          {% for item in cart_items %}
          <div class="store-checkout-item">
            <div class="store-checkout-item-img">
              {% if item.image %}
              <img src="{{ item.image.file.url }}" alt="{{ item.variant.product.name }}">
              {% else %}
              <div class="store-checkout-item-placeholder">üì¶</div>
              {% endif %}
            </div>
            <div class="store-checkout-item-info">
              <div class="store-checkout-item-title">{{ item.variant.product.name }}</div>
              {% if item.has_variants and not item.needs_selection %}
              <div class="store-checkout-item-variant">
                {% for av in item.variant.attribute_values.all %}
                <span class="store-cart-variant-tag">{{ av.attribute.name }}: {{ av.value }}</span>
                {% endfor %}
              </div>
              {% endif %}
              <div class="store-checkout-item-price">
                {{ item.variant.price }} ‚ÇΩ √ó {{ item.qty }} = {{ item.line_total }} ‚ÇΩ
                <span class="store-checkout-item-pv">PV: {{ item.pv|floatformat:0 }} √ó {{ item.qty }} = {{ item.line_pv|floatformat:0 }}</span>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="store-checkout-total">
          <div>–ò—Ç–æ–≥–æ: {{ total }} ‚ÇΩ</div>
          <div class="store-checkout-total-pv">–ò—Ç–æ–≥–æ PV: {{ total_pv|floatformat:0 }}</div>
        </div>
      </div>

      <div class="store-checkout-panel" data-panel="2" data-cart-weight="{{ cart_weight_grams|default:1000 }}" data-cart-total="{{ total|floatformat:0 }}">
        <h2 class="store-checkout-panel-title">2. –î–æ—Å—Ç–∞–≤–∫–∞</h2>
        <p class="store-checkout-hint" style="margin-bottom:16px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—É—é –∫–æ–º–ø–∞–Ω–∏—é –∏ —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</p>
        <div class="store-checkout-delivery">
          {% for dm in delivery_methods %}
          <label class="store-checkout-delivery-opt">
            <input type="radio" name="delivery_method" value="{{ dm.pk }}" {% if forloop.first %}checked{% endif %} data-type="{{ dm.delivery_type }}" data-code="{{ dm.code }}">
            <span>{{ dm.name }}</span>
          </label>
          {% endfor %}
          <div class="store-checkout-address" id="delivery-address-fields">
            <input type="hidden" name="cdek_city_code" id="id_cdek_city_code" value="">
            <input type="hidden" name="cdek_pvz_code" id="id_cdek_pvz_code" value="">
            <input type="hidden" name="cdek_tariff_code" id="id_cdek_tariff_code" value="">
            <input type="hidden" name="fivepost_pvz_id" id="id_fivepost_pvz_id" value="">
            <input type="hidden" name="delivery_cost" id="id_delivery_cost" value="">
            {% if user_addresses %}
            <div class="store-checkout-field store-checkout-saved-addresses">
              <label for="id_saved_address">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∞–¥—Ä–µ—Å</label>
              <select id="id_saved_address" class="store-checkout-saved-select">
                <option value="">‚Äî –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é ‚Äî</option>
                {% for addr in user_addresses %}
                <option value="{{ addr.pk }}" data-city="{{ addr.city }}" data-address="{{ addr.address }}">{{ addr.city }}, {{ addr.address|truncatewords:8 }}</option>
                {% endfor %}
              </select>
            </div>
            {% endif %}
            <div class="store-checkout-field store-checkout-city-wrap">
              <label for="id_delivery_city">–ì–æ—Ä–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è</label>
              <input type="text" id="id_delivery_city" name="delivery_city" value="{{ checkout_delivery_city|default:'' }}" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤–æ—Å–∏–±)" autocomplete="off">
              <div class="store-checkout-city-suggest" id="city-suggest" role="listbox" aria-hidden="true"></div>
              <div class="store-checkout-field" id="russianpost-index-wrap" style="display:none; margin-top:8px;">
                <label for="id_russianpost_to_index">–ò–Ω–¥–µ–∫—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏)</label>
                <input type="text" id="id_russianpost_to_index" name="russianpost_to_index" value="" placeholder="190000" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" autocomplete="postal-code">
              </div>
              <div id="cdek-delivery-cost" class="store-checkout-field store-checkout-tariff-wrap" aria-live="polite" style="display:none; margin-top:12px;"></div>
            </div>
            <div class="store-checkout-field" id="pvz-select-wrap" style="display:none;">
              <label for="id_pvz_select">–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</label>
              <select id="id_pvz_select" class="store-checkout-saved-select store-checkout-pvz-select">
              </select>
            </div>
            <div class="store-checkout-field" id="address-courier-wrap">
              <label for="id_delivery_address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
              <textarea id="id_delivery_address" name="delivery_address" rows="2" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞">{{ checkout_delivery_address|default:'' }}</textarea>
            </div>
          </div>
        </div>
        <div class="store-checkout-total" id="delivery-step-total" style="display:none; margin-top:24px;">
          <div class="store-checkout-total-cart">–¢–æ–≤–∞—Ä—ã: <span id="delivery-total-cart">0</span> ‚ÇΩ</div>
          <div class="store-checkout-total-delivery">–î–æ—Å—Ç–∞–≤–∫–∞: <span id="delivery-total-cost">0</span> ‚ÇΩ</div>
          <div class="store-checkout-total-sum">–ò—Ç–æ–≥–æ: <span id="delivery-total-sum">0</span> ‚ÇΩ</div>
        </div>
      </div>

      <div class="store-checkout-panel" data-panel="3">
        <h2 class="store-checkout-panel-title">3. –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –æ–ø–ª–∞—Ç–∞</h2>
        <p class="store-checkout-almost">–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!</p>
        <div class="store-checkout-fields">
          <div class="store-checkout-field">
            <label for="id_name">–ò–º—è *</label>
            <input type="text" id="id_name" name="name" value="{{ checkout_name|default:'' }}" required placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
          </div>
          <div class="store-checkout-field">
            <label for="id_email">Email *</label>
            <input type="email" id="id_email" name="email" value="{{ checkout_email|default:'' }}" required placeholder="email@example.com">
          </div>
          <div class="store-checkout-field">
            <label for="id_phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
            <input type="tel" id="id_phone" name="phone" value="{{ checkout_phone|default:'' }}" required placeholder="+7 900 123-45-67">
            <span class="store-checkout-field-hint">–¢–æ–ª—å–∫–æ –¥–ª—è SMS –æ –¥–æ—Å—Ç–∞–≤–∫–µ</span>
          </div>
          <div class="store-checkout-field">
            <label>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
            <div class="store-checkout-payment">
              <label class="store-checkout-payment-opt">
                <input type="radio" name="payment_type" value="cash" {% if checkout_payment_type != 'online' %}checked{% endif %}>
                <span>–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</span>
              </label>
              <label class="store-checkout-payment-opt">
                <input type="radio" name="payment_type" value="online" {% if checkout_payment_type == 'online' %}checked{% endif %}>
                <span>–û–Ω–ª–∞–π–Ω (—Å–∫–æ—Ä–æ)</span>
              </label>
            </div>
            <div class="store-checkout-wallet-hint">–ë—ã—Å—Ç—Ä–∞—è –æ–ø–ª–∞—Ç–∞ (—Å–∫–æ—Ä–æ):</div>
            <div class="store-checkout-wallet-btns">
              <button type="button" class="store-checkout-wallet-btn" disabled title="–°–∫–æ—Ä–æ">
                <span class="store-wallet-icon" aria-hidden="true">üçé</span> Apple Pay
              </button>
              <button type="button" class="store-checkout-wallet-btn" disabled title="–°–∫–æ—Ä–æ">
                <span class="store-wallet-icon" aria-hidden="true">G</span> Google Pay
              </button>
            </div>
          </div>
          <div class="store-checkout-field">
            <label for="id_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
            <textarea id="id_comment" name="comment" rows="3" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">{{ checkout_comment|default:'' }}</textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="store-checkout-actions">
      <button type="button" class="store-checkout-btn store-checkout-btn-back" id="checkout-back" style="display:none">–ù–∞–∑–∞–¥</button>
      <button type="button" class="store-checkout-btn store-checkout-btn-next" id="checkout-next">–î–∞–ª–µ–µ</button>
      <button type="submit" class="store-checkout-btn store-checkout-btn-submit" id="checkout-submit" style="display:none">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </form>
</div>

<script>
(function() {
  var form = document.getElementById('checkout-form');
  var panels = form.querySelectorAll('.store-checkout-panel');
  var steps = document.querySelectorAll('.store-checkout-step');
  var backBtn = document.getElementById('checkout-back');
  var nextBtn = document.getElementById('checkout-next');
  var submitBtn = document.getElementById('checkout-submit');
  var addressFields = document.getElementById('delivery-address-fields');
  var deliveryRadios = form.querySelectorAll('input[name="delivery_method"]');

  var currentStep = 1;
  var totalSteps = 3;

  function showStep(n) {
    currentStep = Math.max(1, Math.min(totalSteps, n));
    if (currentStep === 2) fetchDeliveryCost();
    panels.forEach(function(p) {
      var num = parseInt(p.dataset.panel, 10);
      p.classList.toggle('store-checkout-panel-visible', num === currentStep);
    });
    steps.forEach(function(s) {
      var num = parseInt(s.dataset.step, 10);
      s.classList.toggle('store-checkout-step-active', num <= currentStep);
      s.classList.toggle('store-checkout-step-current', num === currentStep);
    });
    backBtn.style.display = currentStep > 1 ? '' : 'none';
    nextBtn.style.display = currentStep < totalSteps ? '' : 'none';
    submitBtn.style.display = currentStep === totalSteps ? '' : 'none';
  }

  function validateStep(n) {
    if (n === 1) return true;
    if (n === 2) {
      var checked = form.querySelector('input[name="delivery_method"]:checked');
      if (!checked) return false;
      var type = checked.dataset.type;
      var city = form.querySelector('#id_delivery_city').value.trim();
      var carrier = getCurrentCarrier();
      if (carrier === 'russianpost') {
        var idx = (document.getElementById('id_russianpost_to_index').value || '').replace(/\s/g, '');
        if (idx.length !== 6 || !/^\d{6}$/.test(idx)) return false;
      } else {
        if (!city) return false;
        if (carrier === 'cdek' && !document.getElementById('id_cdek_city_code').value) return false;
      }
      var deliveryCost = document.getElementById('id_delivery_cost').value;
      if (!deliveryCost || parseFloat(deliveryCost) <= 0) return false;
      if (type === 'pvz' && carrier !== 'russianpost') {
        if (carrier === 'cdek') return !!document.getElementById('id_cdek_pvz_code').value.trim();
        return !!document.getElementById('id_fivepost_pvz_id').value.trim();
      }
      var addr = form.querySelector('#id_delivery_address').value.trim();
      return !!addr;
    }
    if (n === 3) {
      var name = form.querySelector('#id_name').value.trim();
      var email = form.querySelector('#id_email').value.trim();
      var phone = form.querySelector('#id_phone').value.trim();
      return !!(name && email && phone && email.indexOf('@') !== -1);
    }
    return true;
  }

  function getCurrentCarrier() {
    var checked = form.querySelector('input[name="delivery_method"]:checked');
    var code = checked ? (checked.dataset.code || '') : '';
    if (code === 'russianpost') return 'russianpost';
    return code.indexOf('cdek') === 0 ? 'cdek' : 'fivepost';
  }

  function toggleAddressFields() {
    var checked = form.querySelector('input[name="delivery_method"]:checked');
    var isPvz = checked && checked.dataset.type === 'pvz';
    var carrier = getCurrentCarrier();
    var pvzWrap = document.getElementById('pvz-select-wrap');
    var addrWrap = document.getElementById('address-courier-wrap');
    var rpIndexWrap = document.getElementById('russianpost-index-wrap');
    if (rpIndexWrap) rpIndexWrap.style.display = carrier === 'russianpost' ? '' : 'none';
    if (pvzWrap) pvzWrap.style.display = (isPvz && carrier !== 'russianpost') ? '' : 'none';
    if (addrWrap) addrWrap.style.display = (isPvz && carrier !== 'russianpost') ? 'none' : '';
    if (carrier === 'russianpost' && isPvz) addrWrap.style.display = '';
    if (isPvz && carrier !== 'russianpost') {
      if (carrier === 'cdek') {
        document.getElementById('id_fivepost_pvz_id').value = '';
        var code = document.getElementById('id_cdek_city_code').value;
        if (code) fetchPvzList(parseInt(code, 10));
      } else {
        document.getElementById('id_cdek_pvz_code').value = '';
        var city = document.getElementById('id_delivery_city').value.trim();
        if (city) fetchFivepostPvzList(city);
      }
    } else {
      document.getElementById('id_delivery_address').value = '';
    }
    if (lastCdekTariffs && lastCdekCity) renderTariffChoice(lastCdekTariffs, lastCdekCity);
    var city = document.getElementById('id_delivery_city').value.trim();
    if (city) fetchDeliveryCost();
  }

  deliveryRadios.forEach(function(r) {
    r.addEventListener('change', function() {
      document.getElementById('id_delivery_cost').value = '';
      document.getElementById('id_cdek_tariff_code').value = '';
      if (getCurrentCarrier() !== 'russianpost') document.getElementById('id_russianpost_to_index').value = '';
      toggleAddressFields();
    });
  });
  var rpIndexInput = document.getElementById('id_russianpost_to_index');
  if (rpIndexInput) {
    rpIndexInput.addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '').slice(0, 6);
      if (this.value.length === 6) fetchRussianpostCost(this.value);
    });
    rpIndexInput.addEventListener('blur', function() {
      if (this.value.length === 6) fetchRussianpostCost(this.value);
    });
  }
  toggleAddressFields();

  var savedSelect = document.getElementById('id_saved_address');
  if (savedSelect) {
    savedSelect.addEventListener('change', function() {
      var opt = this.options[this.selectedIndex];
      if (opt && opt.value) {
        var city = opt.dataset.city || '';
        document.getElementById('id_delivery_city').value = city;
        document.getElementById('id_delivery_address').value = opt.dataset.address || '';
        document.getElementById('id_cdek_city_code').value = '';
        if (getCurrentCarrier() === 'fivepost') fetchFivepostCost(city); else fetchCdekCost(city);
      }
    });
  }

  function fetchPvzList(cityCode) {
    var sel = document.getElementById('id_pvz_select');
    if (!sel) return;
    sel.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/cdek/pvz/?city_code=' + cityCode, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) return;
      var results = [];
      if (xhr.status === 200) {
        try {
          var data = JSON.parse(xhr.responseText);
          results = data.results || [];
        } catch (e) {}
      }
      sel.innerHTML = '';
      if (!results.length) {
        var o = document.createElement('option');
        o.value = '';
        o.disabled = true;
        o.textContent = '–ù–µ—Ç –ø—É–Ω–∫—Ç–æ–≤ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ';
        sel.appendChild(o);
      } else {
        results.forEach(function(p) {
          var opt = document.createElement('option');
          opt.value = p.code;
          opt.dataset.name = p.name || '';
          opt.dataset.address = p.address || '';
          opt.textContent = (p.name || '') + (p.address ? ' ‚Äî ' + p.address : '');
          sel.appendChild(opt);
        });
        sel.selectedIndex = 0;
        sel.dispatchEvent(new Event('change'));
      }
    };
    xhr.send();
  }

  function fetchFivepostPvzList(cityName) {
    var sel = document.getElementById('id_pvz_select');
    if (!sel || !cityName || !cityName.trim()) return;
    sel.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/fivepost/pvz/?city=' + encodeURIComponent(cityName.trim()), true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) return;
      var results = [];
      if (xhr.status === 200) {
        try {
          var data = JSON.parse(xhr.responseText);
          results = data.results || [];
        } catch (e) {}
      }
      sel.innerHTML = '';
      if (!results.length) {
        var o = document.createElement('option');
        o.value = '';
        o.disabled = true;
        o.textContent = '–ù–µ—Ç –ø—É–Ω–∫—Ç–æ–≤ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ';
        sel.appendChild(o);
      } else {
        results.forEach(function(p) {
          var opt = document.createElement('option');
          opt.value = p.id || p.code || '';
          opt.dataset.name = p.name || '';
          opt.dataset.address = p.address || '';
          opt.textContent = (p.name || '') + (p.address ? ' ‚Äî ' + p.address : '');
          sel.appendChild(opt);
        });
        sel.selectedIndex = 0;
        sel.dispatchEvent(new Event('change'));
      }
    };
    xhr.send();
  }

  var pvzSelect = document.getElementById('id_pvz_select');
  if (pvzSelect) {
    pvzSelect.addEventListener('change', function() {
      var opt = this.options[this.selectedIndex];
      var addrInput = document.getElementById('id_delivery_address');
      var carrier = getCurrentCarrier();
      if (carrier === 'cdek') {
        document.getElementById('id_cdek_pvz_code').value = opt && opt.value ? opt.value : '';
        document.getElementById('id_fivepost_pvz_id').value = '';
      } else {
        document.getElementById('id_fivepost_pvz_id').value = opt && opt.value ? opt.value : '';
        document.getElementById('id_cdek_pvz_code').value = '';
      }
      if (addrInput && opt && opt.value) addrInput.value = (opt.dataset.name || '') + (opt.dataset.address ? ', ' + opt.dataset.address : '');
    });
  }

  var lastCdekTariffs = null;
  var lastCdekCity = '';

  function updateDeliveryTotal() {
    var block = document.getElementById('delivery-step-total');
    if (!block) return;
    var panel = form.querySelector('.store-checkout-panel[data-panel="2"]');
    var cartTotal = panel && panel.dataset.cartTotal ? parseFloat(String(panel.dataset.cartTotal).replace(/\s/g, '')) : 0;
    if (isNaN(cartTotal)) cartTotal = 0;
    var costEl = document.getElementById('id_delivery_cost');
    var deliveryCost = costEl && costEl.value ? parseFloat(costEl.value) : 0;
    if (isNaN(deliveryCost)) deliveryCost = 0;
    var sum = cartTotal + deliveryCost;
    var fmt = function(n) { return String(Math.round(n)).replace(/(\d)(?=(\d{3})+$)/g, '$1 '); };
    var cartSpan = document.getElementById('delivery-total-cart');
    var costSpan = document.getElementById('delivery-total-cost');
    var sumSpan = document.getElementById('delivery-total-sum');
    if (cartSpan) cartSpan.textContent = fmt(cartTotal);
    if (costSpan) costSpan.textContent = fmt(deliveryCost);
    if (sumSpan) sumSpan.textContent = fmt(sum);
    block.style.display = (deliveryCost > 0) ? '' : 'none';
  }

  function formatTariffLabel(t) {
    var days = t.period_min === t.period_max ? String(t.period_max) : t.period_min + '‚Äì' + t.period_max;
    var rawName = (t.name || '').replace(/\s*(–¥–≤–µ—Ä—å-–¥–≤–µ—Ä—å|—Å–∫–ª–∞–¥-—Å–∫–ª–∞–¥|–¥–≤–µ—Ä—å-—Å–∫–ª–∞–¥|—Å–∫–ª–∞–¥-–¥–≤–µ—Ä—å)\s*/gi, '').trim();
    var shortName = rawName.replace(/\s*–¥–æ\s+\d+\s*$/i, '').trim() || '–î–æ—Å—Ç–∞–≤–∫–∞';
    var costFormatted = String(Math.round(t.delivery_sum)).replace(/(\d)(?=(\d{3})+$)/g, '$1 ');
    return { shortName: shortName, costFormatted: costFormatted, days: days };
  }

  function renderTariffChoice(tariffs, city) {
    var block = document.getElementById('cdek-delivery-cost');
    if (!block || !tariffs || !tariffs.length) return;
    var checked = form.querySelector('input[name="delivery_method"]:checked');
    var isCourier = checked && checked.dataset.type === 'courier';
    var wantMode = isCourier ? 1 : 4;
    var filtered = tariffs.filter(function(t) { return Number(t.delivery_mode) === wantMode; });
    var label = isCourier ? '–¥–≤–µ—Ä—å-–¥–≤–µ—Ä—å' : '—Å–∫–ª–∞–¥-—Å–∫–ª–∞–¥';
    var first = filtered[0];
    document.getElementById('id_delivery_cost').value = first ? first.delivery_sum : '';
    document.getElementById('id_cdek_tariff_code').value = first ? (first.tariff_code || '') : '';
    var html = '';
    if (!filtered.length) {
      html = '<p class="store-tariff-empty">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ (' + label + ').</p>';
    } else {
      html = '<label for="id_cdek_tariff">–¢–∞—Ä–∏—Ñ –¥–æ ' + (city || '') + '</label>' +
        '<select id="id_cdek_tariff" class="store-checkout-saved-select">';
      filtered.forEach(function(t, idx) {
        var lbl = formatTariffLabel(t);
        var optVal = (t.tariff_code || '') + '|' + t.delivery_sum;
        var optText = lbl.shortName + ' ‚Äî ' + lbl.costFormatted + ' ‚ÇΩ ¬∑ ' + lbl.days + ' –¥–Ω.';
        html += '<option value="' + optVal.replace(/"/g, '&quot;') + '"' + (idx === 0 ? ' selected' : '') + '>' + optText + '</option>';
      });
      html += '</select>';
    }
    block.innerHTML = html;
    var sel = block.querySelector('select');
    if (sel) {
      sel.addEventListener('change', function() {
        var parts = this.value.split('|');
        document.getElementById('id_cdek_tariff_code').value = parts[0] || '';
        document.getElementById('id_delivery_cost').value = parts[1] || '';
        updateDeliveryTotal();
      });
    }
    updateDeliveryTotal();
  }

  function fetchFivepostCost(cityName) {
    var block = document.getElementById('cdek-delivery-cost');
    if (!block || !cityName || !cityName.trim()) { if (block) { block.style.display = 'none'; } lastCdekTariffs = null; return; }
    var panel = form.querySelector('.store-checkout-panel[data-panel="2"]');
    var weight = (panel && panel.dataset.cartWeight) ? parseInt(panel.dataset.cartWeight, 10) : 1000;
    if (isNaN(weight) || weight < 500) weight = 1000;
    block.style.display = 'block';
    block.innerHTML = '<div class="store-tariff-loading">–†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ 5post...</div>';
    var url = '/api/fivepost/delivery-cost/?city=' + encodeURIComponent(cityName.trim()) + '&weight=' + weight;
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) return;
      if (xhr.status === 200) {
        try {
          var data = JSON.parse(xhr.responseText);
          if (data.ok && data.price != null) {
            var checked = form.querySelector('input[name="delivery_method"]:checked');
            var mode = (checked && checked.dataset.type === 'pvz') ? 4 : 1;
            var tariffs = [{ delivery_sum: data.price, period_min: data.delivery_days || 0, period_max: data.delivery_days || 0, name: '5post', delivery_mode: mode }];
            lastCdekTariffs = tariffs;
            lastCdekCity = data.city || cityName || '';
            document.getElementById('id_cdek_tariff_code').value = '';
            renderTariffChoice(tariffs, lastCdekCity);
            if (checked && checked.dataset.type === 'pvz') fetchFivepostPvzList(cityName.trim());
          } else {
            document.getElementById('id_delivery_cost').value = '';
            block.innerHTML = '<p class="store-tariff-error">' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å.') + '</p>';
            updateDeliveryTotal();
          }
        } catch (e) {
          document.getElementById('id_delivery_cost').value = '';
          block.innerHTML = '<p class="store-tariff-error">–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞.</p>';
          updateDeliveryTotal();
        }
      } else {
        document.getElementById('id_delivery_cost').value = '';
        block.innerHTML = '<p class="store-tariff-error">–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ 5post.</p>';
        updateDeliveryTotal();
      }
    };
    xhr.send();
  }

  function fetchCdekCost(cityName, cityCode) {
    var block = document.getElementById('cdek-delivery-cost');
    if (!block) return;
    if (!cityName && !cityCode) { block.style.display = 'none'; lastCdekTariffs = null; return; }
    var panel = form.querySelector('.store-checkout-panel[data-panel="2"]');
    var weight = (panel && panel.dataset.cartWeight) ? parseInt(panel.dataset.cartWeight, 10) : 1000;
    if (isNaN(weight) || weight < 500) weight = 1000;
    block.style.display = 'block';
    block.innerHTML = '<div class="store-tariff-loading">–†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ –°–î–≠–ö...</div>';
    var url = '/api/cdek/delivery-cost/?weight=' + weight;
    if (cityCode) url += '&city_code=' + cityCode;
    if (cityName && cityName.trim()) url += '&city=' + encodeURIComponent(cityName.trim());
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) return;
      if (xhr.status === 200) {
        try {
          var data = JSON.parse(xhr.responseText);
          if (data.ok && data.tariffs && data.tariffs.length) {
            lastCdekTariffs = data.tariffs;
            lastCdekCity = data.city || cityName || '';
            renderTariffChoice(data.tariffs, lastCdekCity);
            if (data.city_code && !document.getElementById('id_cdek_city_code').value) {
              document.getElementById('id_cdek_city_code').value = data.city_code;
              var checked = form.querySelector('input[name="delivery_method"]:checked');
              if (checked && checked.dataset.type === 'pvz') fetchPvzList(data.city_code);
            }
          } else {
            document.getElementById('id_delivery_cost').value = '';
            document.getElementById('id_cdek_tariff_code').value = '';
            block.innerHTML = '<p class="store-tariff-error">' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å.') + '</p>';
            updateDeliveryTotal();
          }
        } catch (e) {
          document.getElementById('id_delivery_cost').value = '';
          document.getElementById('id_cdek_tariff_code').value = '';
          block.innerHTML = '<p class="store-tariff-error">–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞.</p>';
          updateDeliveryTotal();
        }
      } else {
        try {
          var err = JSON.parse(xhr.responseText);
          document.getElementById('id_delivery_cost').value = '';
          document.getElementById('id_cdek_tariff_code').value = '';
          block.innerHTML = '<p class="store-tariff-error">' + (err.error || '–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞.') + '</p>';
          updateDeliveryTotal();
        } catch (e) {
          document.getElementById('id_delivery_cost').value = '';
          document.getElementById('id_cdek_tariff_code').value = '';
          block.innerHTML = '<p class="store-tariff-error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.</p>';
          updateDeliveryTotal();
        }
      }
    };
    xhr.send();
  }

  function fetchRussianpostCost(toIndex) {
    var block = document.getElementById('cdek-delivery-cost');
    if (!block) return;
    toIndex = String(toIndex).replace(/\s/g, '');
    if (toIndex.length !== 6 || !/^\d{6}$/.test(toIndex)) { block.style.display = 'none'; lastCdekTariffs = null; return; }
    var panel = form.querySelector('.store-checkout-panel[data-panel="2"]');
    var weight = (panel && panel.dataset.cartWeight) ? parseInt(panel.dataset.cartWeight, 10) : 1000;
    if (isNaN(weight) || weight < 1) weight = 1000;
    var sumoc = (panel && panel.dataset.cartTotal) ? parseFloat(String(panel.dataset.cartTotal).replace(/\s/g, '')) : 100;
    if (isNaN(sumoc) || sumoc < 0.01) sumoc = 100;
    block.style.display = 'block';
    block.innerHTML = '<div class="store-tariff-loading">–†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ –ü–æ—á—Ç—ã –†–æ—Å—Å–∏–∏...</div>';
    var url = '/api/russianpost/delivery-cost/?to_index=' + toIndex + '&weight=' + weight + '&sumoc=' + Math.round(sumoc);
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) return;
      if (xhr.status === 200) {
        try {
          var data = JSON.parse(xhr.responseText);
          if (data.ok && data.price != null) {
            var tariffs = [{ delivery_sum: data.price, period_min: data.delivery_days || 0, period_max: data.delivery_days || 0, name: data.name || '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏', delivery_mode: 1 }];
            lastCdekTariffs = tariffs;
            lastCdekCity = '–ò–Ω–¥–µ–∫—Å ' + toIndex;
            document.getElementById('id_cdek_tariff_code').value = '';
            renderTariffChoice(tariffs, lastCdekCity);
          } else {
            document.getElementById('id_delivery_cost').value = '';
            block.innerHTML = '<p class="store-tariff-error">' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å.') + '</p>';
            updateDeliveryTotal();
          }
        } catch (e) {
          document.getElementById('id_delivery_cost').value = '';
          block.innerHTML = '<p class="store-tariff-error">–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞.</p>';
          updateDeliveryTotal();
        }
      } else {
        document.getElementById('id_delivery_cost').value = '';
        block.innerHTML = '<p class="store-tariff-error">–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –ü–æ—á—Ç—ã –†–æ—Å—Å–∏–∏.</p>';
        updateDeliveryTotal();
      }
    };
    xhr.send();
  }

  function fetchDeliveryCost() {
    var carrier = getCurrentCarrier();
    if (carrier === 'russianpost') {
      var idx = (document.getElementById('id_russianpost_to_index').value || '').replace(/\s/g, '');
      if (idx.length === 6 && /^\d{6}$/.test(idx)) fetchRussianpostCost(idx);
      return;
    }
    var cityInput = document.getElementById('id_delivery_city');
    var city = cityInput ? cityInput.value.trim() : '';
    if (!city) return;
    if (carrier === 'fivepost') fetchFivepostCost(city);
    else fetchCdekCost(city, document.getElementById('id_cdek_city_code').value ? parseInt(document.getElementById('id_cdek_city_code').value, 10) : null);
  }

  (function cityAutocomplete() {
    var input = document.getElementById('id_delivery_city');
    var list = document.getElementById('city-suggest');
    var debounceTimer;

    function hideSuggest() {
      list.innerHTML = '';
      list.setAttribute('aria-hidden', 'true');
      list.style.display = 'none';
    }

    function showSuggest(items) {
      list.innerHTML = '';
      if (!items || !items.length) { hideSuggest(); return; }
      items.forEach(function(item) {
        var el = document.createElement('div');
        el.className = 'store-checkout-city-suggest-item';
        el.setAttribute('role', 'option');
        el.textContent = item.city + (item.region && item.region !== item.city ? ' (' + item.region + ')' : '');
        el.dataset.code = item.code;
        el.dataset.city = item.city;
        el.addEventListener('mousedown', function(e) {
          e.preventDefault();
          var code = item.code;
          var city = item.city;
          input.value = city;
          var codeInput = document.getElementById('id_cdek_city_code');
          var carrier = getCurrentCarrier();
          if (codeInput) codeInput.value = (carrier === 'cdek') ? code : '';
          document.getElementById('id_cdek_pvz_code').value = '';
          document.getElementById('id_fivepost_pvz_id').value = '';
          document.getElementById('id_delivery_address').value = '';
          var pvzSel = document.getElementById('id_pvz_select');
          if (pvzSel) { pvzSel.innerHTML = ''; }
          hideSuggest();
          input.focus();
          fetchDeliveryCost();
        });
        list.appendChild(el);
      });
      list.style.display = 'block';
      list.setAttribute('aria-hidden', 'false');
    }

    function fetchCities(q) {
      if (!q || q.length < 2) { hideSuggest(); return; }
      list.style.display = 'block';
      list.setAttribute('aria-hidden', 'false');
      list.innerHTML = '<div class="store-checkout-city-suggest-item" style="color:var(--store-muted);">–ü–æ–∏—Å–∫...</div>';
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/api/cdek/cities/?q=' + encodeURIComponent(q), true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState !== 4) return;
        if (xhr.status === 200) {
          try {
            var data = JSON.parse(xhr.responseText);
            var items = data.results || [];
            if (!items.length) {
              list.innerHTML = '<div class="store-checkout-city-suggest-item" style="color:var(--store-muted); cursor:default;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ.</div>';
              list.style.display = 'block';
              return;
            }
            showSuggest(items);
          } catch (e) { hideSuggest(); }
        } else { hideSuggest(); }
      };
      xhr.send();
    }

    input.addEventListener('input', function() {
      var q = this.value.trim();
      clearTimeout(debounceTimer);
      if (!q) {
        document.getElementById('id_cdek_city_code').value = '';
        document.getElementById('id_cdek_pvz_code').value = '';
        document.getElementById('id_fivepost_pvz_id').value = '';
        document.getElementById('id_delivery_cost').value = '';
        var pvzSel = document.getElementById('id_pvz_select');
        if (pvzSel) pvzSel.innerHTML = '';
        updateDeliveryTotal();
        hideSuggest();
        return;
      }
      debounceTimer = setTimeout(function() { fetchCities(q); }, 200);
    });
    input.addEventListener('focus', function() {
      var q = this.value.trim();
      if (q.length >= 2) fetchCities(q);
    });
    input.addEventListener('blur', function() { setTimeout(hideSuggest, 150); });
    input.addEventListener('keydown', function(e) { if (e.key === 'Escape') hideSuggest(); });
    document.addEventListener('click', function(e) {
      if (e.target !== input && !list.contains(e.target)) hideSuggest();
    });
  })();

  backBtn.addEventListener('click', function() { showStep(currentStep - 1); });
  nextBtn.addEventListener('click', function() {
    if (!validateStep(currentStep)) {
      if (currentStep === 2) alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥, —Ç–∞—Ä–∏—Ñ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å (–∏–ª–∏ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏).');
      else alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.');
      return;
    }
    showStep(currentStep + 1);
  });
  form.addEventListener('submit', function(e) {
    if (currentStep !== totalSteps) { e.preventDefault(); return; }
    if (!validateStep(3)) { e.preventDefault(); alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω.'); return; }
  });

  showStep(1);
})();
</script>
{% endblock %}
