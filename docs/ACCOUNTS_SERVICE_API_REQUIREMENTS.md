# Техническое задание: API сервиса работы со счетами

**Проект:** Hardcode Store  
**Назначение:** Интеграция интернет-магазина с сервисом учёта счетов пользователей  
**Дата:** 2026

---

## 1. Контекст

Магазин должен интегрироваться с внешним сервисом работы со счетами. У пользователя может быть несколько счетов (основной, бонусный и т.д.). Необходимо:

- Отображать счета и балансы в ЛК
- Показывать детализацию (операции по счёту)
- Выполнять переводы между пользователями и видеть историю переводов
- **Списывать средства со счёта при оформлении заказа** (оплата со счёта)

---

## 2. Идентификация пользователей

Магазин использует собственную модель пользователя с полями:
- `id` (integer) — внутренний PK
- `uuid` (UUID v4) — уникальный идентификатор для интеграций

**Требование:** API должен принимать идентификатор пользователя магазина. Предпочтительно — `user_uuid` (строка UUID). Альтернатива: `user_id` (integer) — если сервис счетов синхронизирован с той же БД пользователей.

---

## 3. Задачи на разработку API

### 3.1. Список счетов пользователя

**Задача:** Получение списка счетов пользователя с текущим балансом.

**Метод:** `GET`

**Параметры запроса:**
- `user_uuid` или `user_id` — идентификатор пользователя

**Ожидаемый ответ:**
```json
{
  "accounts": [
    {
      "id": "string или int",
      "name": "Основной счёт",
      "balance": "1234.56",
      "currency": "RUB",
      "type": "main"
    }
  ]
}
```

**Требования:**
- У пользователя может быть 2–3 счёта (основной, бонусный и т.д.)
- `balance` — строка или число с 2 знаками после запятой
- Необходима пагинация, если счетов больше N (например, 20)

---

### 3.2. Детализация по счёту (операции)

**Задача:** Получение списка операций по счёту (движение средств).

**Метод:** `GET`

**Параметры запроса:**
- `account_id` — идентификатор счёта
- `user_uuid` или `user_id` — идентификатор пользователя (проверка прав)
- `from_date`, `to_date` (опционально) — период в ISO 8601
- `page`, `limit` (опционально) — пагинация

**Ожидаемый ответ:**
```json
{
  "operations": [
    {
      "id": "string",
      "date": "2026-01-15T14:30:00Z",
      "type": "debit|credit|transfer_in|transfer_out",
      "amount": "100.00",
      "currency": "RUB",
      "balance_after": "1100.00",
      "description": "Оплата заказа #100001",
      "reference_id": "order_uuid или другой внешний ID"
    }
  ],
  "total_count": 50
}
```

**Требования:**
- Сортировка по дате (новые сверху)
- Типы операций: списание (`debit`), зачисление (`credit`), перевод входящий/исходящий

---

### 3.3. Перевод другому пользователю

**Задача:** Выполнение перевода средств с одного пользователя другому.

**Метод:** `POST`

**Тело запроса:**
```json
{
  "from_user_uuid": "uuid отправителя",
  "to_user_uuid": "uuid получателя",
  "amount": "500.00",
  "currency": "RUB",
  "account_id": "id счёта списания (если несколько счетов)",
  "comment": "необязательный комментарий"
}
```

**Ожидаемый ответ (успех):**
```json
{
  "transfer_id": "string",
  "status": "completed",
  "created_at": "2026-01-15T14:30:00Z"
}
```

**Ожидаемый ответ (ошибка):**
```json
{
  "error": "insufficient_balance",
  "message": "Недостаточно средств на счёте"
}
```

**Требования:**
- Атомарность: либо перевод выполнен полностью, либо не выполнен
- Валидация: проверка баланса, существования получателя
- Возврат кодов ошибок: `insufficient_balance`, `account_not_found`, `user_not_found`, `invalid_amount`

---

### 3.4. История переводов

**Задача:** Получение истории переводов пользователя (исходящие и входящие).

**Метод:** `GET`

**Параметры запроса:**
- `user_uuid` или `user_id`
- `direction`: `outgoing` | `incoming` | `all` (по умолчанию `all`)
- `page`, `limit`
- `from_date`, `to_date` (опционально)

**Ожидаемый ответ:**
```json
{
  "transfers": [
    {
      "id": "string",
      "direction": "outgoing",
      "from_user_uuid": "uuid",
      "to_user_uuid": "uuid",
      "to_user_email": "email получателя (маскированный при необходимости)",
      "amount": "100.00",
      "currency": "RUB",
      "status": "completed",
      "created_at": "2026-01-15T14:30:00Z",
      "comment": "строка или null"
    }
  ],
  "total_count": 25
}
```

---

### 3.5. Списание при оформлении заказа

**Задача:** Резервирование/списание средств со счёта пользователя при оплате заказа.

**Метод:** `POST`

**Тело запроса:**
```json
{
  "user_uuid": "uuid пользователя",
  "account_id": "id счёта (опционально, если один счёт — использовать его)",
  "amount": "1500.00",
  "currency": "RUB",
  "order_uuid": "uuid заказа в магазине",
  "order_number": "100001",
  "description": "Оплата заказа #100001"
}
```

**Ожидаемый ответ (успех):**
```json
{
  "transaction_id": "string",
  "status": "completed",
  "balance_after": "500.00"
}
```

**Ожидаемый ответ (ошибка):**
```json
{
  "error": "insufficient_balance",
  "message": "Недостаточно средств"
}
```

**Требования:**
- Атомарность: списание только при успешном ответе
- `order_uuid` — идемпотентность: повторный запрос с тем же `order_uuid` не должен списывать повторно
- Коды ошибок: `insufficient_balance`, `account_not_found`, `duplicate_order` (заказ уже оплачен)

---

### 3.6. Проверка баланса (опционально)

**Задача:** Быстрая проверка, хватит ли средств на оплату заказа.

**Метод:** `GET` или `POST`

**Параметры:**
- `user_uuid`
- `amount`

**Ответ:**
```json
{
  "sufficient": true,
  "balance": "2000.00",
  "currency": "RUB"
}
```

---

### 3.7. Возврат при отмене заказа

**Задача:** Возврат средств на счёт при отмене оплаченного заказа.

**Метод:** `POST`

**Тело запроса:**
```json
{
  "user_uuid": "uuid",
  "order_uuid": "uuid заказа",
  "amount": "1500.00",
  "currency": "RUB",
  "reason": "order_cancelled"
}
```

**Требования:**
- Идемпотентность по `order_uuid`
- Возврат только если заказ ранее был оплачен со счёта

---

## 4. Аутентификация и безопасность

**Требования:**
- API должен быть защищён (API-ключ, OAuth, mTLS — на усмотрение разработчиков сервиса)
- Документация: способ передачи credentials, примеры запросов (cURL, Postman)
- HTTPS обязательно

---

## 5. Формат взаимодействия

**Предпочтительно:** REST API, JSON  
**Альтернатива:** gRPC, GraphQL — при наличии документации и клиентов

**Базовый URL:** Переменная окружения (например, `ACCOUNTS_API_URL`), документировать в настройках магазина.

---

## 6. Что нужно отдать магазину

1. **Документация API** — описание всех методов, параметров, кодов ответа
2. **Примеры запросов** — cURL или Postman collection
3. **Тестовый стенд** — URL и credentials для проверки интеграции
4. **Список кодов ошибок** — для корректной обработки на стороне магазина

---

## 7. Сводная таблица endpoints

| Задача | Метод | Назначение |
|--------|-------|------------|
| Список счетов | GET | Счета + балансы пользователя |
| Детализация | GET | Операции по счёту |
| Перевод | POST | Перевод другому пользователю |
| История переводов | GET | Исходящие/входящие переводы |
| Списание при заказе | POST | Оплата заказа со счёта |
| Проверка баланса | GET/POST | Достаточно ли средств |
| Возврат при отмене | POST | Возврат при отмене заказа |
