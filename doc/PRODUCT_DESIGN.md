# Проектирование: товары, наборы, услуги, каталог

Рекомендации по структуре хранения и логике для каталога ИМ.

---

## 1. Типы сущностей в каталоге

| Тип | Описание | Цена | Остаток |
|-----|----------|------|---------|
| **Простой товар** | Один SKU, без вариантов (или один «дефолтный» вариант) | Одна цена | Один остаток |
| **Товар с вариантами** | Варианты по характеристикам (цвет, размер и т.п.) | Цена общая или своя на вариант | Свой остаток на вариант |
| **Составной товар (бокс)** | Фиксированный набор позиций, состав не меняется | Своя цена за бокс | Нет своего остатка — списываем компоненты |
| **Набор-конструктор** | Клиент сам собирает состав из предложенных позиций | Зависит от выбора (сумма или фикс) | Списываем выбранные позиции |
| **Услуга** | Доставка, работы, подписка и т.п. | Своя цена | Остатка нет |

---

## 2. Товар с характеристиками (варианты)

**Структура:**
- **Product** — базовая карточка: название, описание, категория, общие фото, slug.
- **ProductAttribute** — справочник атрибутов: «Цвет», «Размер» и т.п.
- **ProductAttributeValue** — значения: «Красный», «S», «M», «L».
- **ProductVariant** — конкретная комбинация: привязка к Product + набор AttributeValue. Свои: price, stock, sku, image (если нужно).

**Примеры:**
- Товар «Футболка» → варианты: (S, красный), (S, синий), (M, красный)… Каждый вариант — своя цена и остаток.
- Товар «Коврик» → один вариант (без выбора) — одна цена, один остаток.
- Товар «Чашка» → варианты только по цвету — цена может быть общей для всех цветов.

**Цена:** хранить в ProductVariant. Если цена одинаковая — можно задавать её на уровне Product и переопределять в варианте при необходимости.

**Остаток:** только в ProductVariant. Товар без вариантов — один «дефолтный» вариант.

---

## 3. Составной товар (бокс с фиксированным составом)

**Идея:** бокс не имеет собственного складового остатка. Остаток определяется компонентами.

**Структура:**
- **Product** с типом `composite` (или отдельная модель CompositeProduct).
- **CompositeProductItem** — состав: product_id (или variant_id), quantity. Связь многие-ко-многим через промежуточную таблицу с quantity.

**Логика остатков (как в WooCommerce, Magento и др.):**
1. При добавлении в корзину/оформлении заказа проверяем: для каждого компонента `stock >= quantity × qty_in_basket`.
2. При подтверждении заказа **списываем каждый компонент** на `quantity × qty_ordered`.
3. У самого бокса поля `stock` нет — он «виртуальный».

**Особенности:**
- Можно задать «страховой» остаток по компонентам (резерв под боксы).
- При нуле любого компонента бокс недоступен к заказу (или «под заказ»).

---

## 4. Набор-конструктор (клиент собирает состав)

**Идея:** есть шаблон набора с допустимыми позициями и правилами. Клиент выбирает состав.

**Структура:**
- **Product** с типом `configurable_kit` (или ConfigurableKit).
- **KitTemplate** — шаблон: набор допустимых product/variant + min/max кол-ва, обязательные позиции.
- В заказе (OrderItem) храним не «набор», а **развёрнутый список** выбранных позиций (product_id, variant_id, quantity, price). То есть в OrderItem попадают конкретные товары/варианты.

**Цена:**
- Фиксированная цена набора — задаём на наборе.
- Или сумма выбранных позиций (со скидкой) — считаем при добавлении в корзину.

**Остатки:** при оформлении списываем выбранные позиции по количеству. Проверка — как у обычных товаров: достаточен ли остаток по каждому выбранному варианту.

---

## 5. Услуги

**Структура:**
- **Service** (или Product с типом `service`): название, описание, цена, slug.
- Остатка нет. Может быть «доступность» (например, доставка — по зонам).

**Примеры:** доставка, сборка, консультация, подписка.

**В заказе:** OrderItem с product_id (услуга), quantity (обычно 1), price. Без списания остатков.

---

## 6. Иерархия каталога (категории)

**Зачем:**
- Навигация: «Электроника → Наушники → Беспроводные».
- Фильтрация: показывать товары по категории и подкатегориям.
- SEO: отдельные URL для разделов.
- В админке: группировка при добавлении товара.

**Структура:**
- **Category**: id, name, slug, parent_id (null для корня), sort_order, is_active.
- Иерархия через `parent_id`. Глубина — 2–3 уровня (корень → раздел → подраздел).

**В админке:**
- Дерево категорий (или список с отступами).
- При создании категории — выбор родителя.
- При создании товара — выбор категории (можно ограничить листьями дерева, чтобы товар не висел на «разделе» с подкатегориями — по желанию).

---

## 7. Рекомендуемые таблицы (черновик)

```
Brand
  id, name, slug, is_active

Category
  id, name, slug, parent_id, sort_order, is_active

ProductAttribute
  id, name, code (color, size...)

ProductAttributeValue  
  id, attribute_id, value (Красный, S, M...)

Product
  id, category_id, brand_id (nullable), article (nullable, не уникальный), name, slug, description, 
  product_type (simple/variable/composite/configurable_kit/service), is_active, sort_order, created_at, updated_at

ProductVariant
  id, product_id, price, stock, is_default, weight_g, length_mm, width_mm, height_mm
  (связь с AttributeValue — через ProductVariantAttribute: variant_id, attribute_value_id)

ProductMedia
  id, product_id, variant_id (nullable), file, media_type (image/video), sort_order

CompositeProductItem  (фаза 3)
  id, product_id (бокс), variant_id (компонент), quantity

KitTemplateItem  (фаза 4)
  id, product_id (набор), variant_id (допустимая позиция), min_qty, max_qty, is_required

Service  (или product_type=service)
  id, name, slug, description, price, is_active
```

---

## 8. Справка: как списывают остаток в типовых системах

| Система | Составной товар / набор |
|---------|-------------------------|
| **WooCommerce** | Списывает остаток у каждого компонента набора при продаже. Сам набор своего остатка не имеет. |
| **Magento** | Аналогично: bundle без собственного stock, списание по компонентам. |
| **Commercetools** | Режимы: None, TrackOnly (списание при заказе), ReserveOnOrder (резерв при добавлении в корзину). |

**Вывод:** составной товар и набор — списываем компоненты. Собственный stock только у простых товаров и вариантов.

---

## 9. Что ещё учесть при проектировании

| Аспект | Рекомендация |
|--------|--------------|
| **SKU** | Уникальный на вариант (или на товар, если один вариант). Нужен для учёта, интеграций, ТК. |
| **Черновики** | Поле `is_active` или статус `draft/published` — товар в каталоге только после публикации. |
| **Мягкое удаление** | `deleted_at` или `is_deleted`, чтобы не терять связь с заказами. |
| **Цены** | Базовая цена в ProductVariant. Валюта — одна (руб). Скидки/акции — отдельный этап. |
| **Фото** | На уровне Product (общие) и/или ProductVariant (для цвета и т.п.). |
| **Линейки/коллекции** | Отдельная модель Collection, связь M2M с Product — для блоков «Хиты», «Новинки». |
| **Вынос остатков в сервис** | Обращение к `stock` только через слой сервиса; внутри — вызов нашей БД или внешнего API. |
| **Атрибуты** | На старте — фиксированный набор (цвет, размер). Позже — справочники с возможностью расширения. |

---

## 10. Финальный набор атрибутов (по решениям)

### Product (базовая карточка)

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| id | UUID / int | да | Уникальный ID, **генерируется системой** |
| article | string | нет | **Артикул** — вводится вручную, **может быть не уникальным** |
| name | string | да | Название |
| slug | string | да | URL, уникальный |
| description | text | да | Описание |
| category_id | FK | да | Категория |
| brand_id | FK | нет | Бренд (справочник, один на товар) |
| product_type | enum | да | simple / variable / composite / configurable_kit / service |
| is_active | bool | да | Публикация в каталоге |
| sort_order | int | нет | Порядок вывода |
| created_at, updated_at | datetime | да | Аудит |

### ProductVariant (вариант)

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| id | UUID / int | да | Генерируется системой |
| product_id | FK | да | Товар |
| price | decimal | да | Цена |
| stock | int | да | Остаток (для товаров с остатком) |
| is_default | bool | нет | Вариант по умолчанию (для простого товара) |
| weight_g | int | нет | **Вес, граммы** (для доставки) |
| length_mm | int | нет | **Длина, мм** |
| width_mm | int | нет | **Ширина, мм** |
| height_mm | int | нет | **Высота, мм** |

### ProductMedia (фото и видео)

| Поле | Тип | Описание |
|------|-----|----------|
| product_id | FK | Товар |
| variant_id | FK | Вариант (nullable) — если фото привязано к варианту |
| file | file | Файл (изображение или видео) |
| media_type | enum | image / video |
| sort_order | int | Порядок вывода |

**Видео:** загружаемый файл. Превью — генерируем при загрузке или отдельное поле для превью-картинки.

### Brand (справочник)

| Поле | Тип | Описание |
|------|-----|----------|
| id | int | ID |
| name | string | Название бренда |
| slug | string | URL (для фильтра) |
| is_active | bool | Активен |

### Характеристики (на старте)

- **Цвет** и **Размер** — справочники ProductAttribute / ProductAttributeValue. Привязка к варианту.

---

## 11. Формат Excel для загрузки товаров

Пользователь заполняет Excel по этому формату. Столбцы:

| Столбец | Обязательно | Пример | Примечание |
|---------|-------------|--------|------------|
| name | да | Кофе арабика 250г | Название товара |
| article | нет | ART-001 | Артикул (может повторяться) |
| description | нет | Свежеобжаренный... | Описание |
| category | да | Кофе | Название или slug категории (должна существовать) |
| brand | нет | Lavazza | Название бренда (создаётся при импорте, если нет) |
| price | да | 450 | Цена, руб |
| stock | да | 100 | Остаток |
| weight_g | нет | 250 | Вес, г |
| length_mm | нет | 50 | Длина, мм |
| width_mm | нет | 50 | Ширина, мм |
| height_mm | нет | 100 | Высота, мм |
| color | нет | Красный | Значение «Цвет» (если товар с вариантами) |
| size | нет | M | Значение «Размер» (если товар с вариантами) |

**Правила:**
- Один ряд — один вариант. Товар с двумя цветами — два ряда с одинаковым name, article, разными color.
- Простой товар (без вариантов) — один ряд, color и size пустые.
- Категория и бренд — по имени; при импорте ищем по slug/name, при отсутствии создаём (категория — уточнить, куда класть: в корень или указать родителя в отдельном столбце).
- Фото/видео через Excel не загружаются — добавляются вручную в карточке после импорта (или отдельный импорт по артикулу — позже).

Шаблон Excel можно сформировать после согласования структуры.

---

## 12. Составные товары и наборы — позже

Составной товар (бокс) и набор-конструктор планируется добавить **после** запуска простых товаров и вариантов. Архитектура уже предусматривает `product_type` (composite, configurable_kit) и заготовки таблиц (CompositeProductItem, KitTemplateItem) — при добавлении потребуется доработка логики, но не переработка схемы.

---

## 13. Поэтапное внедрение

**Фаза 1 (старт):**
- Brand, Category (с parent_id)
- Product (simple/variable), ProductVariant — артикул на Product, вес и габариты (г, мм) на Variant
- ProductMedia (фото и видео — загрузка файлов)
- ProductAttribute, ProductAttributeValue (цвет, размер)
- Импорт из Excel по заданному формату, создание карточки вручную

**Фаза 2 (после запуска):**
- Составной товар (CompositeProductItem), списание по компонентам
- Услуги (Service)

**Фаза 3:**
- Набор-конструктор (KitTemplate, логика выбора и развёртки в OrderItem)

---

Если нужно, могу упростить схему под «только фаза 1» или добавить диаграмму связей.
