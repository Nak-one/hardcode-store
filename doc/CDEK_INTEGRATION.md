# Интеграция доставки СДЭК (API v2.0)

Краткий обзор по [документации СДЭК API](https://apidoc.cdek.ru/) и [SDK 2.0](https://cdek-it-sdk20.readthedocs.io/) для внедрения в магазин.

---

## 1. Доступ к API

- **Учётные данные:** `account` (логин) и `secure` (секретный пароль). Их нужно **запросить у СДЭК** по почте: **integrator@cdek.ru**. Доступы от личного кабинета СДЭК не подходят.
- **Тестовый режим:** у СДЭК есть тестовые `account` и `secure`; запросы уходят на тестовый сервер.

**Базовые URL:**
- Прод: `https://api.cdek.ru` (или `https://integration.cdek.ru` — уточнять в письме от СДЭК).
- Тест: `https://integration.edu.cdek.ru`.

---

## 2. Авторизация (OAuth 2.0)

- **Метод:** `POST /oauth/token`
- **Content-Type:** `application/x-www-form-urlencoded`
- **Тело:** `grant_type=client_credentials&client_id={account}&client_secret={secure}` (либо параметры в формате, указанном в актуальной документации на apidoc.cdek.ru).
- **Ответ:** JSON с полями:
  - `access_token` — токен для последующих запросов;
  - `expires_in` — время жизни в секундах (обычно 3599, т.е. ~6 минут).
- Все остальные запросы к API выполняются с заголовком:  
  `Authorization: Bearer {access_token}`.

Токен нужно кэшировать и обновлять до истечения срока.

---

## 3. Методы, нужные для доставки в магазине

| Задача | Метод API | Назначение |
|--------|-----------|------------|
| Расчёт стоимости и сроков | Калькулятор тарифов | Стоимость и срок доставки «до двери» или до ПВЗ по коду тарифа (город/направление, вес, габариты). |
| Список ПВЗ | Список офисов/ПВЗ | Адрес, телефон, режим работы пунктов выдачи (для выбора на чекауте). |
| Коды городов | Список городов | Поиск города по названию, получение `code` (нужен для калькулятора и заказа). |
| Создание заказа в СДЭК | Создание заказа | После оформления заказа у нас — передача заказа в СДЭК (отправитель, получатель, места, тариф). |
| Статусы заказа | Информация по заказу / вебхуки | Отслеживание статуса доставки и обновление у нас. |

В официальной документации на [apidoc.cdek.ru](https://apidoc.cdek.ru) и в [SDK 2.0](https://cdek-it-sdk20.readthedocs.io/) описаны:

- **Калькулятор** — расчёт по одному тарифу или по списку тарифов (направление, вес, габариты).
- **ПВЗ** — `offices()` / delivery points: полный список или с фильтром (например, по региону/городу).
- **Города** — `cities()->getFiltered()` (фильтр по стране, названию и т.д.).
- **Заказы** — создание, получение, удаление; структура заказа: отправитель, получатель, места (посылки), тариф.

Точные пути запросов (например, `/v2/calculator/tariff`, `/v2/deliverypoints` и т.п.) нужно смотреть в актуальной версии документации на портале.

---

## 4. Что сделать в нашем проекте (Django)

1. **Настройки**
   - В `settings` или `.env` вынести: `CDEK_ACCOUNT`, `CDEK_SECURE`, флаг тестового режима и при необходимости базовый URL API.

2. **Клиент СДЭК (заготовка в коде)**
   - Модуль (например, `orders.cdek_client`): получение и кэширование токена; функции-обёртки для:
     - калькулятора (город отправления, город назначения, вес, габариты → стоимость и срок);
     - списка ПВЗ (по городу/региону);
     - списка городов (поиск по названию для подсказок на чекауте).

3. **Чекаут**
   - При выборе доставки СДЭК (курьер или ПВЗ):
     - поле «Город» — подсказки из справочника городов СДЭК (или уже имеющийся каталог городов, сопоставленный с кодами СДЭК);
     - после выбора города получателя — вызов калькулятора (наш город отправления + город получателя + вес/габариты корзины), показ стоимости и срока;
     - для тарифа «до ПВЗ» — выбор пункта из списка ПВЗ по городу, подстановка кода ПВЗ в заказ.

4. **Модели**
   - Уже есть `DeliveryMethod` (курьер, ПВЗ). Добавить способ доставки «СДЭК» (два варианта: СДЭК курьер, СДЭК ПВЗ) или привязать существующие к СДЭК по коду.
   - В заказе хранить: код тарифа СДЭК, код ПВЗ (если ПВЗ), внешний uuid заказа СДЭК после создания.

5. **Создание заказа в СДЭК**
   - После успешного оформления заказа у нас (и при выборе доставки СДЭК) — вызов API создания заказа СДЭК (отправитель = наши реквизиты, получатель = данные клиента, места = из состава заказа), сохранение uuid/номера заказа СДЭК в нашем заказе.

6. **Статусы**
   - По желанию: подписка на вебхуки СДЭК по статусам заказа и обновление статуса доставки в нашем заказе.

---

## 5. Полезные ссылки

- [Портал документации СДЭК API](https://apidoc.cdek.ru/) — актуальные методы, форматы запросов/ответов.
- [Интеграция по API (cdek.ru)](https://www.cdek.ru/ru/integration/api/) — общее описание.
- [SDK 2.0 для PHP (Read the Docs)](https://cdek-it-sdk20.readthedocs.io/) — примеры вызовов (авторизация, заказы, ПВЗ, города, печатные формы).
- Запрос учётных данных для интеграции: **integrator@cdek.ru**.

После получения `account` и `secure` можно подключить заготовку клиента в `orders.cdek_client`, подставить URL из документации и реализовать по шагам: калькулятор → города → ПВЗ → создание заказа.
